apiVersion: core.oam.dev/v1beta1
kind: Application
metadata:
  name: platform-poc
  annotations:
    version: v0.0.1
    description: "A PoC for Wasm Components"
spec:
  components:
    #################### COMPONENTS ####################
    - name: data-init
      type: component
      properties:
        image: localhost:5001/v2/platform-poc/data_init:0.1.0
        id: data-init
      traits:
        - type: spreadscaler
          properties:
            instances: 1
        - type: link
          properties:
            namespace: wasmcloud
            package: postgres
            interfaces: [query]
            target:
              name: sqldb-postgres
              config:
                - name: platform_poc-default_postgres
        - type: link
          properties:
            namespace: wasi
            package: keyvalue
            interfaces: [store]
            target:
              name: kv-redis
              config:
                - name: platform_poc-default_redis

    - name: http-controller
      type: component
      properties:
        image: localhost:5001/v2/platform-poc/http_controller:0.1.0
        id: http-controller
      traits:
        - type: spreadscaler
          properties:
            instances: 1000
        - type: link
          properties:
            namespace: platform-poc
            package: products
            interfaces: [products]
            target:
              name: products-service
        - type: link
          properties:
            namespace: platform-poc
            package: data-init
            interfaces: [init-funcs]
            target:
              name: data-init
        - type: link
          properties:
            namespace: platform-poc
            package: inventory
            interfaces: [inventory]
            target:
              name: inventory-service
        - type: link
          properties:
            namespace: platform-poc
            package: orders
            interfaces: [orders]
            target:
              name: orders-service

    - name: products-service
      type: component
      properties:
        image: localhost:5001/v2/platform-poc/products_service:0.1.0
        id: products-service
      traits:
        - type: spreadscaler
          properties:
            instances: 1000
        - type: link
          properties:
            namespace: wasi
            package: keyvalue
            interfaces: [store]
            target:
              name: kv-redis
              config:
                - name: platform_poc-default_redis

    - name: inventory-service
      type: component
      properties:
        image: localhost:5001/v2/platform-poc/inventory_service:0.1.0
        id: inventory-service
      traits:
        - type: spreadscaler
          properties:
            instances: 1000
        - type: link
          properties:
            namespace: wasmcloud
            package: postgres
            interfaces: [query]
            target:
              name: sqldb-postgres
              config:
                - name: platform_poc-default_postgres

    - name: notification-service
      type: component
      properties:
        image: localhost:5001/v2/platform-poc/notification_service:0.1.0
        id: notification-service
      traits:
        - type: spreadscaler
          properties:
            instances: 1000

    - name: orders-service
      type: component
      properties:
        image: localhost:5001/v2/platform-poc/orders_service:0.1.0
        id: orders-service
      traits:
        - type: spreadscaler
          properties:
            instances: 1000
        - type: link
          properties:
            namespace: wasmcloud
            package: postgres
            interfaces: [query]
            target:
              name: sqldb-postgres
              config:
                - name: platform_poc-default_postgres
        - type: link
          properties:
            namespace: platform-poc
            package: inventory
            interfaces: [inventory]
            target:
              name: inventory-service
        - type: link
          properties:
            namespace: wasmcloud
            package: messaging
            interfaces: [consumer]
            target:
              name: nats

    #################### CAPABILITIES ####################

    - name: http-server
      type: capability
      properties:
        image: wasmcloud+builtin://http-server
        id: http-server
        config:
          - name: default-http
            properties:
              address: 0.0.0.0:8081
      traits:
        - type: link
          properties:
            namespace: wasi
            package: http
            interfaces: [incoming-handler]
            source:
              config:
                - name: platform_poc-default_http
            target:
              name: http-controller

    - name: kv-redis
      type: capability
      properties:
        image: ghcr.io/wasmcloud/keyvalue-redis:0.28.2
        id: kv-redis
        config:
          - name: default-redis
            properties:
              url: "redis://127.0.0.1:6379"

    - name: sqldb-postgres
      type: capability
      properties:
        image: ghcr.io/wasmcloud/sqldb-postgres:0.7.2
        id: sqldb-postgres
        config:
          - name: default-postgres
            properties:
              POSTGRES_HOST: localhost
              POSTGRES_PORT: "5432"
              POSTGRES_USERNAME: postgres
              POSTGRES_PASSWORD: postgres
              POSTGRES_DATABASE: postgres
              POSTGRES_TLS_REQUIRED: "false"

    - name: nats
      type: capability
      properties:
        image: wasmcloud+builtin://messaging-nats
        id: nats
        config:
          - name: default-nats
            properties:
              subscriptions: "platform-poc.order-notification"
      traits:
        - type: link
          properties:
            namespace: wasmcloud
            package: messaging
            interfaces: [handler]
            source:
              config:
                - name: platform_poc-default_nats
            target:
              name: notification-service
